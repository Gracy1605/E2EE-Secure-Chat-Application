<!DOCTYPE html>
<html>
<head>
  <title>üîê Secure Chat</title>
  <script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
  <div class="chat-container">
    <h2>üîí Secure Chat with E2EE</h2>

    <div id="chat-box" class="chat-box"></div>

    <div class="input-area">
      <input type="text" id="msg" placeholder="Type a message">
      <button onclick="sendEncryptedMessage()">Send</button>
    </div>
  </div>

  <script>
    let socket = io();
    let publicKey, privateKey;
    let peerPublicKey;

    // Generate RSA key pair
    async function generateRSAKeys() {
      const keyPair = await window.crypto.subtle.generateKey(
        { name: "RSA-OAEP", modulusLength: 2048, publicExponent: new Uint8Array([1,0,1]), hash: "SHA-256" },
        true,
        ["encrypt", "decrypt"]
      );
      publicKey = keyPair.publicKey;
      privateKey = keyPair.privateKey;

      const exported = await window.crypto.subtle.exportKey("spki", publicKey);
      const pubKeyBase64 = btoa(String.fromCharCode(...new Uint8Array(exported)));

      socket.emit("public_key", pubKeyBase64);
    }

    generateRSAKeys();

    socket.on("connect", () => {
      console.log("Connected to server");
    });

    // Receive peer public key
    socket.on("peer_public_key", async (data) => {
      const binary = Uint8Array.from(atob(data), c => c.charCodeAt(0));
      peerPublicKey = await window.crypto.subtle.importKey(
        "spki", binary, { name: "RSA-OAEP", hash: "SHA-256" }, true, ["encrypt"]
      );
      console.log("Received peer's public key");
    });

    // Receive encrypted message
    socket.on("message", async (data) => {
      const encryptedKey = Uint8Array.from(atob(data.encrypted_key), c => c.charCodeAt(0));
      const encryptedMessage = Uint8Array.from(atob(data.encrypted_message), c => c.charCodeAt(0));

      const aesKey = await window.crypto.subtle.decrypt({ name: "RSA-OAEP" }, privateKey, encryptedKey);
      const aesCryptoKey = await window.crypto.subtle.importKey("raw", aesKey, { name: "AES-GCM" }, false, ["decrypt"]);

      const decrypted = await window.crypto.subtle.decrypt(
        { name: "AES-GCM", iv: new Uint8Array(12) },
        aesCryptoKey,
        encryptedMessage
      );

      const messageText = new TextDecoder().decode(decrypted);
      appendMessage(`Friend: ${messageText}`, "received");
    });

    // Function to append messages
    function appendMessage(text, type) {
      const box = document.getElementById("chat-box");
      const div = document.createElement("div");
      div.className = `message ${type}`;
      div.innerText = text;
      box.appendChild(div);
      box.scrollTop = box.scrollHeight; // auto-scroll to bottom
    }

    // Send encrypted message
    async function sendEncryptedMessage() {
      if (!peerPublicKey) {
        alert("Waiting for peer public key...");
        return;
      }

      const msgInput = document.getElementById("msg");
      const msg = msgInput.value.trim();
      if (!msg) return;

      msgInput.value = "";

      appendMessage(`You: ${msg}`, "sent");

      const aesKeyRaw = window.crypto.getRandomValues(new Uint8Array(32));
      const aesCryptoKey = await window.crypto.subtle.importKey("raw", aesKeyRaw, { name: "AES-GCM" }, false, ["encrypt"]);

      const encoded = new TextEncoder().encode(msg);
      const encryptedMessage = await window.crypto.subtle.encrypt({ name: "AES-GCM", iv: new Uint8Array(12) }, aesCryptoKey, encoded);
      const encryptedKey = await window.crypto.subtle.encrypt({ name: "RSA-OAEP" }, peerPublicKey, aesKeyRaw);

      socket.emit("message", {
        encrypted_key: btoa(String.fromCharCode(...new Uint8Array(encryptedKey))),
        encrypted_message: btoa(String.fromCharCode(...new Uint8Array(encryptedMessage)))
      });
    }

    // Enter key listener (outside send function)
    document.getElementById("msg").addEventListener("keypress", function(event) {
      if (event.key === "Enter") {
        event.preventDefault();
        sendEncryptedMessage();
      }
    });
  </script>
</body>
</html>
